#!/usr/bin/env bash
# Pre-commit hook to lint agent markdown files.
# Install with: ln -s ../../.githooks/agent-lint .git/hooks/pre-commit
# (Run from repo root.)

set -euo pipefail

ROOT_DIR="$(git rev-parse --show-toplevel)"
cd "$ROOT_DIR"

# Activate venv if exists
if [ -f .venv/bin/activate ]; then
  # shellcheck disable=SC1091
  source .venv/bin/activate
fi

PYTHON_BIN="python"

if ! command -v "$PYTHON_BIN" >/dev/null 2>&1; then
  echo "[agent-lint] Python not found in PATH" >&2
  exit 1
fi

# Run linter (order auto-fix allowed inside commit)
$PYTHON_BIN scripts/lint_agents.py --roots opencode claude --require-model --check-order || STATUS=$?
STATUS=${STATUS:-0}

if [ "$STATUS" -ne 0 ]; then
  echo "\n[agent-lint] Violations detected. Commit aborted." >&2
  echo "Run: python scripts/lint_agents.py --roots opencode claude --check-order to auto-fix ordering." >&2
  exit "$STATUS"
fi

exit 0
